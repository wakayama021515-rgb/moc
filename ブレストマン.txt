import React, { useState, useEffect, useRef } from 'react';
import { Play, Settings, Brain, Users, Award, ChevronDown, ChevronUp, Loader2, Layers, Eye, EyeOff, AlertCircle, List, Zap, RefreshCw, GitBranch, Sparkles, Download, Database, BarChart, Plus, Trash2, Shuffle, Target, Activity, Clock, FileText, Network, Grid3x3, TrendingUp, Compass, Package, Lightbulb, Combine } from 'lucide-react';

const AIEconomySystemV4 = () => {
  // ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®š
  const [globalWish, setGlobalWish] = useState('ãƒãƒ£ãƒ¼ãƒãƒ³ãƒ¬ã‚·ãƒ”ã®é–‹ç™º');
  const [background, setBackground] = useState('ãƒãƒ¼ãƒœãƒ¼ãƒãƒ£ãƒ¼ãƒãƒ³ã®æ–°é®®ã•ã‚’å†ã³');
  
  // è¦³ç‚¹ãƒã‚¹ã‚¿ãƒ¼ãƒªã‚¹ãƒˆ
  const perspectives = [
    { id: 'direct', name: 'ç›´çƒ', prompt: 'ç›´æ¥çš„ã«è§£æ±ºã™ã‚‹è¦ç´ ' },
    { id: 'traditional', name: 'ä¼çµ±', prompt: 'æ­´å²çš„ã«è¨¼æ˜ã•ã‚ŒãŸæ‰‹æ³•' },
    { id: 'trends', name: 'ãƒˆãƒ¬ãƒ³ãƒ‰', prompt: 'æœ€æ–°ãƒˆãƒ¬ãƒ³ãƒ‰ã€æœ€æ–°æŠ€è¡“' },
    { id: 'emotion', name: 'æ„Ÿæƒ…', prompt: 'æ„Ÿæƒ…ä½“é¨“ã€ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£' },
    { id: 'problem', name: 'èª²é¡Œ', prompt: 'å•é¡Œç‚¹ã€ãƒšã‚¤ãƒ³ãƒã‚¤ãƒ³ãƒˆ' },
    { id: 'ideal', name: 'ç†æƒ³', prompt: 'éš ã‚ŒãŸé¡˜æœ›ã€ç†æƒ³çš„ãªæœªæ¥' },
    { id: 'improvement', name: 'æ”¹å–„', prompt: 'æ—¢å­˜ã®ã‚‚ã®ã‚’æ”¹å–„' },
    { id: 'fusion', name: 'èåˆ', prompt: 'ç•°åˆ†é‡ã‹ã‚‰ã®è¦ç´ ' },
    { id: 'chaos', name: 'ã‚«ã‚ªã‚¹', prompt: 'ãƒ©ãƒ³ãƒ€ãƒ ã§ç•°åˆ†é‡ãªè¦ç´ ' }
  ];

  // ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ï¼ˆSCAMPERçµ±åˆï¼‰
  const layer2Types = [
    { id: 'substitute', name: 'S:ä»£æ›¿', description: 'è¦ç´ ã‚’åˆ¥ã®ã‚‚ã®ã«ç½®ãæ›ãˆã‚‹' },
    { id: 'combine', name: 'C:çµåˆ', description: 'è¤‡æ•°ã®è¦ç´ ã‚’çµ„ã¿åˆã‚ã›ã‚‹' },
    { id: 'adapt', name: 'A:é©å¿œ', description: 'ä»–åˆ†é‡ã‹ã‚‰é©å¿œã•ã›ã‚‹' },
    { id: 'modify', name: 'M:ä¿®æ­£/æ‹¡å¤§', description: 'ä¿®æ­£ãƒ»æ‹¡å¤§ãƒ»ç¸®å°ã™ã‚‹' },
    { id: 'put-other', name: 'P:è»¢ç”¨', description: 'åˆ¥ã®ç”¨é€”ã«è»¢ç”¨ã™ã‚‹' },
    { id: 'eliminate', name: 'E:å‰Šé™¤', description: 'ä¸è¦ãªè¦ç´ ã‚’å‰Šé™¤ã™ã‚‹' },
    { id: 'reverse', name: 'R:é€†è»¢', description: 'é€†è»¢ãƒ»å†é…ç½®ã™ã‚‹' },
    { id: 'random', name: 'ãƒ©ãƒ³ãƒ€ãƒ ', description: 'ãƒ©ãƒ³ãƒ€ãƒ SCAMPER' },
    { id: 'free', name: 'ãƒ•ãƒªãƒ¼', description: 'è‡ªç”±ç™ºæƒ³' }
  ];

  // æ§‹é€ åŒ–æ‰‹æ³•ï¼ˆL3å±¤ï¼‰
  const structuringMethods = [
    { id: 'edge-graph', name: 'ã‚¨ãƒƒã‚¸ã‚°ãƒ©ãƒ•', description: 'é–¢ä¿‚æ€§ã‚’ã‚°ãƒ©ãƒ•æ§‹é€ ã§åˆ†æ', icon: Network },
    { id: 'matrix', name: 'ãƒãƒˆãƒªã‚¯ã‚¹', description: 'ç›¸é–¢ãƒãƒˆãƒªã‚¯ã‚¹ã§åˆ†æ', icon: Grid3x3 },
    { id: 'multi-index', name: 'å¤šè»¸ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹', description: 'å¤šæ¬¡å…ƒã§åˆ†é¡ãƒ»æ•´ç†', icon: BarChart },
    { id: 'clustering', name: 'ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°', description: 'é¡ä¼¼åº¦ã§ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°', icon: GitBranch },
    { id: 'hierarchy', name: 'éšå±¤æ§‹é€ ', description: 'éšå±¤çš„ã«æ•´ç†', icon: List },
    { id: 'network', name: 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯', description: 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ†æ', icon: Sparkles }
  ];

  const layer4Criteria = [
    { id: 'effective', name: 'æœ‰åŠ¹Ã—å®Ÿç¾', description: 'å®Ÿç”¨çš„ã§å®Ÿç¾å¯èƒ½' },
    { id: 'unique', name: 'ç‹¬å‰µÃ—å®Ÿç¾', description: 'ç‹¬å‰µçš„ã§å®Ÿç¾å¯èƒ½' },
    { id: 'bizarre', name: 'å¥‡æŠœÃ—é•·æœŸ', description: 'å¥‡æŠœã§é•·æœŸçš„ä¾¡å€¤' },
    { id: 'synergy', name: 'ã‚·ãƒŠã‚¸ãƒ¼', description: 'ç›¸ä¹—åŠ¹æœãŒé«˜ã„' },
    { id: 'disruptive', name: 'ç ´å£Šçš„', description: 'æ—¢å­˜ã®æ çµ„ã¿ã‚’ç ´å£Š' }
  ];

  const evaluationCriteria = [
    { id: 'feasibility', name: 'å®Ÿç¾å¯èƒ½æ€§' },
    { id: 'innovation', name: 'é©æ–°æ€§' },
    { id: 'user-value', name: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¾¡å€¤' },
    { id: 'technical', name: 'æŠ€è¡“çš„å„ªä½æ€§' },
    { id: 'sustainability', name: 'æŒç¶šå¯èƒ½æ€§' },
    { id: 'cost', name: 'ã‚³ã‚¹ãƒˆåŠ¹ç‡' }
  ];

  // å±¤åˆ¥ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè¨­å®š
  const [layer1Agents, setLayer1Agents] = useState([
    { id: 'l1-1', perspectives: ['direct', 'problem'] },
    { id: 'l1-2', perspectives: ['trends', 'ideal'] }
  ]);

  const [layer2Agents, setLayer2Agents] = useState([
    { id: 'l2-1', type: 'substitute', entityCount: 8 },
    { id: 'l2-2', type: 'combine', entityCount: 8 },
    { id: 'l2-3', type: 'adapt', entityCount: 8 }
  ]);

  const [layer3Agents, setLayer3Agents] = useState([
    { id: 'l3-1', method: 'edge-graph' },
    { id: 'l3-2', method: 'clustering' }
  ]);

  const [layer4Agents, setLayer4Agents] = useState([
    { id: 'l4-1', criteria: 'effective' },
    { id: 'l4-2', criteria: 'synergy' }
  ]);

  const [layer5Agents, setLayer5Agents] = useState([
    { id: 'l5-1', criteria: 'feasibility' },
    { id: 'l5-2', criteria: 'innovation' }
  ]);

  const [layer2Iterations, setLayer2Iterations] = useState(2);
  const [batchSize, setBatchSize] = useState(2); 
  const [apiDelay, setApiDelay] = useState(1000); 
  
  // å‡¦ç†çŠ¶æ…‹
  const [isProcessing, setIsProcessing] = useState(false);
  const [currentPhase, setCurrentPhase] = useState('idle');
  const [currentIteration, setCurrentIteration] = useState(0);
  const [logs, setLogs] = useState([]);
  const [activeRequests, setActiveRequests] = useState(0);
  const logsEndRef = useRef(null);
  
  // çµæœãƒ‡ãƒ¼ã‚¿
  const [baseAnalysis, setBaseAnalysis] = useState(null);
  const [allEntities, setAllEntities] = useState([]);
  const [layer1Results, setLayer1Results] = useState([]);
  const [layer2Results, setLayer2Results] = useState([]);
  const [layer2IterationHistory, setLayer2IterationHistory] = useState([]);
  const [layer3Results, setLayer3Results] = useState([]);
  const [layer4Results, setLayer4Results] = useState([]);
  const [evaluations, setEvaluations] = useState([]);
  const [finalReport, setFinalReport] = useState(null);
  
  // APIé€šä¿¡å±¥æ­´
  const [apiHistory, setApiHistory] = useState([]);
  
  // UIçŠ¶æ…‹
  const [showSettings, setShowSettings] = useState(true);
  const [showApiHistory, setShowApiHistory] = useState(false);
  const [showBaseAnalysis, setShowBaseAnalysis] = useState(true);
  const [showEntities, setShowEntities] = useState(true);
  const [showIdeas, setShowIdeas] = useState(true);
  const [showStructures, setShowStructures] = useState(true);
  const [showSolutions, setShowSolutions] = useState(true);

  const [expandedApiHistory, setExpandedApiHistory] = useState(new Set());
  const [expandedStructures, setExpandedStructures] = useState(new Set());
  const [randomSeed, setRandomSeed] = useState(Date.now());

  useEffect(() => {
    logsEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [logs]);

  const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

  const mulberry32 = (seed) => {
    return function() {
      let t = (seed += 0x6D2B79F5);
      t = Math.imul(t ^ (t >>> 15), t | 1);
      t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
      return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
    };
  };

  const sampleUnique = (arr, k, rng = Math.random) => {
    const a = [...arr];
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(rng() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a.slice(0, Math.min(k, a.length));
  };

  const addLog = (message, type = 'info') => {
    const timestamp = new Date().toLocaleTimeString('ja-JP');
    setLogs(prev => [...prev.slice(-100), { message, type, timestamp }]);
  };

  const addApiHistory = (request, response, error = null) => {
    const entry = {
      id: `api-${Date.now()}-${Math.random()}`,
      timestamp: new Date().toISOString(),
      request,
      response,
      error,
      success: !error
    };
    setApiHistory(prev => [...prev, entry]);
    return entry;
  };

  const executeBatch = async (tasks, batchSize = 3, delayMs = 500) => {
    const results = [];
    for (let i = 0; i < tasks.length; i += batchSize) {
      const batch = tasks.slice(i, i + batchSize);
      const batchPromises = batch.map(async (task, index) => {
        setActiveRequests(prev => prev + 1);
        try {
          if (i > 0 || index > 0) await delay(delayMs);
          return await task();
        } finally {
          setActiveRequests(prev => prev - 1);
        }
      });
      const batchResults = await Promise.all(batchPromises);
      results.push(...batchResults);
    }
    return results;
  };

  const callGeminiAPI = async (messages, maxRetries = 2, maxTokens = 8000) => {
    const apiKey = "";
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
    const promptText = messages.map(msg => msg.content).join('\n\n');
    const requestData = {
      contents: [{ parts: [{ text: promptText }] }],
      generationConfig: { responseMimeType: "application/json", maxOutputTokens: maxTokens, temperature: 0.7 }
    };
    let lastError = null;
    for (let attempt = 1; attempt <= maxRetries; attempt++) {
      try {
        if (attempt > 1) {
          const waitTime = Math.min(Math.pow(2, attempt) * 1000, 10000);
          addLog(`â³ ãƒªãƒˆãƒ©ã‚¤ ${attempt}/${maxRetries}: ${waitTime/1000}ç§’å¾…æ©Ÿ`, 'warning');
          await delay(waitTime);
        }
        const response = await fetch(apiUrl, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(requestData) });
        if (response.status === 429) throw new Error('Rate limit exceeded.');
        const data = await response.json();
        if (!response.ok) throw new Error(data.error?.message || `API error: ${response.status}`);
        const candidate = data.candidates?.[0];
        if (candidate && candidate.content?.parts?.[0]?.text) {
          const responseText = candidate.content.parts[0].text;
          try {
            const parsedResponse = JSON.parse(responseText);
            addApiHistory(requestData, parsedResponse);
            return parsedResponse;
          } catch (parseError) {
            addLog(`âŒ JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼: ${parseError.message}`, 'error');
            addLog(`RAWãƒ¬ã‚¹ãƒãƒ³ã‚¹å…¨æ–‡:\n\`\`\`\n${responseText}\n\`\`\``, 'info');
            throw new Error(`Failed to parse API response as JSON. Details: ${parseError.message}`);
          }
        } else {
          const finishReason = candidate?.finishReason || "No candidate found";
          const safetyRatings = JSON.stringify(candidate?.safetyRatings || "N/A");
          throw new Error(`API returned no content. Finish reason: ${finishReason}, Safety ratings: ${safetyRatings}`);
        }
      } catch (error) {
        lastError = error;
        addLog(`âŒ APIã‚³ãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼ (è©¦è¡Œ ${attempt}/${maxRetries}): ${error.message}`, 'error');
      }
    }
    addApiHistory(requestData, null, lastError.message);
    throw lastError;
  };

  const addLayer1Agent = () => {
    const newId = `l1-${Date.now()}`;
    setLayer1Agents(prev => [...prev, { id: newId, perspectives: ['direct'] }]);
  };
  const removeLayer1Agent = (id) => {
    if (layer1Agents.length > 1) setLayer1Agents(prev => prev.filter(a => a.id !== id));
  };
  const updateLayer1Agent = (id, perspectives) => {
    setLayer1Agents(prev => prev.map(a => a.id === id ? {...a, perspectives} : a));
  };
  const addLayer2Agent = () => {
    const newId = `l2-${Date.now()}`;
    setLayer2Agents(prev => [...prev, { id: newId, type: 'random', entityCount: 8 }]);
  };
  const removeLayer2Agent = (id) => {
    if (layer2Agents.length > 1) setLayer2Agents(prev => prev.filter(a => a.id !== id));
  };
  const updateLayer2Agent = (id, type, entityCount) => {
    setLayer2Agents(prev => prev.map(a => a.id === id ? {...a, type, entityCount} : a));
  };
  const addLayer3Agent = () => {
    const newId = `l3-${Date.now()}`;
    setLayer3Agents(prev => [...prev, { id: newId, method: 'edge-graph' }]);
  };
  const removeLayer3Agent = (id) => {
    if (layer3Agents.length > 1) setLayer3Agents(prev => prev.filter(a => a.id !== id));
  };
  const updateLayer3Agent = (id, method) => {
    setLayer3Agents(prev => prev.map(a => a.id === id ? {...a, method} : a));
  };
  const addLayer4Agent = () => {
    const newId = `l4-${Date.now()}`;
    setLayer4Agents(prev => [...prev, { id: newId, criteria: 'effective' }]);
  };
  const removeLayer4Agent = (id) => {
    if (layer4Agents.length > 1) setLayer4Agents(prev => prev.filter(a => a.id !== id));
  };
  const updateLayer4Agent = (id, criteria) => {
    setLayer4Agents(prev => prev.map(a => a.id === id ? {...a, criteria} : a));
  };
  const addLayer5Agent = () => {
    const newId = `l5-${Date.now()}`;
    setLayer5Agents(prev => [...prev, { id: newId, criteria: 'feasibility' }]);
  };
  const removeLayer5Agent = (id) => {
    if (layer5Agents.length > 1) setLayer5Agents(prev => prev.filter(a => a.id !== id));
  };
  const updateLayer5Agent = (id, criteria) => {
    setLayer5Agents(prev => prev.map(a => a.id === id ? {...a, criteria} : a));
  };

  const executeLayer0 = async (wish, bg) => {
    setCurrentPhase('layer0');
    addLog(`ğŸš€ ========== ç¬¬0å±¤é–‹å§‹ï¼ˆãƒ™ãƒ¼ã‚¹åˆ†æï¼‰ ==========`, 'process');
    try {
      const result = await callGeminiAPI([{
        role: "user",
        content: `
          ã‚ãªãŸã¯ç‹é“çš„ãªã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆã«ã—ã¦ãƒ¡ãƒ³ã‚¿ãƒ¼ã€è‰¯ãç›¸è«‡å½¹ã§ã™ã€‚
          ã€é¡˜ã„ã€‘${wish}
          ã€èƒŒæ™¯ã€‘${bg}
          é¡˜ã„ã¨èƒŒæ™¯ã‚’ãƒ™ãƒ¼ã‚¹ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ±‚ã‚ã¦ã„ã‚‹ã‚‚ã®ã‚’ç†è§£ã—ã€ç¾å®Ÿçš„ãªåˆ†æã‚’ä½œæˆã—ãªã•ã„ã€‚
          ä»¥ä¸‹ã®è¦³ç‚¹ã§åŒ…æ‹¬çš„ãªåˆ†æã‚’è¡Œã£ã¦ãã ã•ã„ï¼š
          å¿…ãšä»¥ä¸‹ã®JSONå½¢å¼ã§å¿œç­”ã—ã¦ãã ã•ã„:
          {
            "contextUnderstanding": "ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®çœŸã®ãƒ‹ãƒ¼ã‚ºã®ç†è§£ï¼ˆ50-100æ–‡å­—ï¼‰",
            "orthodoxApproach": [ { "title": "...", "description": "...", "rationale": "..." } ],
            "commonChallenges": [ { "challenge": "...", "impact": "...", "mitigation": "..." } ],
            "commonFailures": [ { "failure": "...", "cause": "...", "prevention": "..." } ],
            "classicalTechniques": [ { "technique": "...", "principle": "...", "application": "..." } ],
            "avoidList": [ { "avoid": "...", "reason": "...", "alternative": "..." } ],
            "fundamentalGoals": [ { "goal": "...", "value": "...", "metrics": "..." } ],
            "strategicDirection": { "primaryFocus": "...", "secondaryFocus": "...", "longTermVision": "..." },
            "realityCheck": { "feasibilityScore": 85, "timeframe": "...", "resourceRequirements": "...", "criticalSuccessFactors": ["..."] }
          }
        `
      }]);
      setBaseAnalysis(result);
      addLog(`âœ… ãƒ™ãƒ¼ã‚¹åˆ†æå®Œäº†`, 'success');
      return result;
    } catch (error) {
      addLog(`âŒ ãƒ™ãƒ¼ã‚¹åˆ†æã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
      throw error;
    }
  };

  const executeLayer1 = async (wish, bg, agents) => {
    setCurrentPhase('layer1');
    addLog(`ğŸš€ ========== ç¬¬1å±¤é–‹å§‹ ==========`, 'process');
    const tasks = agents.map((agent, index) => async () => {
      try {
        const selectedPerspectives = agent.perspectives.map(id => perspectives.find(p => p.id === id));
        const result = await callGeminiAPI([{
          role: "user",
          content: `
            ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ç”Ÿæˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ${index + 1}
            ã‚°ãƒ­ãƒ¼ãƒãƒ«Wish: ${wish}
            èƒŒæ™¯: ${bg}
            è¦³ç‚¹: ${selectedPerspectives.map(p => p.name).join(', ')}
            ä¸Šè¨˜ã®è¦³ç‚¹ã«å¿ å®Ÿã«å¾“ã„ã€Wishã¨èƒŒæ™¯ã«é–¢é€£ã™ã‚‹20å€‹ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
            å¿…ãšä»¥ä¸‹ã®JSONå½¢å¼ã§å¿œç­”ã—ã¦ãã ã•ã„:
            { "agentId": "gen-${index + 1}", "entities": [ { "id": "e${index + 1}-1", "name": "...", "description": "...", "category": "..." } ] }
          `
        }]);
        addLog(`âœ… ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ${index + 1}: ${result.entities.length}å€‹ç”Ÿæˆå®Œäº†`, 'success');
        return result;
      } catch (error) {
        addLog(`âŒ ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ${index + 1}: ã‚¨ãƒ©ãƒ¼`, 'error');
        return null;
      }
    });
    const results = await executeBatch(tasks, batchSize, apiDelay);
    const validResults = results.filter(r => r);
    const allEntitiesList = validResults.flatMap(r => r.entities);
    setLayer1Results(validResults);
    setAllEntities(allEntitiesList);
    addLog(`ğŸ“Š ç¬¬1å±¤å®Œäº†: è¨ˆ${allEntitiesList.length}å€‹ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£`, 'success');
    return { results: validResults, allEntities: allEntitiesList };
  };

  const executeLayer2Iteration = async (wish, bg, agents, entities, iteration, previousIdeas, baseAnalysis) => {
    setCurrentIteration(iteration);
    addLog(`ğŸ”„ --- ç¬¬2å±¤ åå¾©${iteration}/${layer2Iterations} (SCAMPER) ---`, 'process');
    const rng = mulberry32(randomSeed + iteration);
    const baseGuidance = baseAnalysis ? `
      ã€ãƒ™ãƒ¼ã‚¹åˆ†æã‹ã‚‰ã®æŒ‡é‡ã€‘
      - ç‹é“ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ: ${baseAnalysis.orthodoxApproach.map(a => a.title).join(', ')}
      - ã‚ˆãã‚ã‚‹èª²é¡Œ: ${baseAnalysis.commonChallenges.map(c => c.challenge).join(', ')}
      - é¿ã‘ã‚‹ã¹ãã“ã¨: ${baseAnalysis.avoidList.map(a => a.avoid).join(', ')}
      - å¤å…¸çš„æ‰‹æ³•: ${baseAnalysis.classicalTechniques.map(t => t.technique).join(', ')}
      - åŸºæœ¬ç›®æ¨™: ${baseAnalysis.fundamentalGoals.map(g => g.goal).join(', ')}
      ã“ã‚Œã‚‰ã®æ´å¯Ÿã‚’æ´»ã‹ã—ã¦ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚` : '';
    const tasks = agents.map((agent, index) => async () => {
      try {
        let scamperInstruction = '';
        const selectedEntities = sampleUnique(entities, agent.entityCount || 8, rng);
        switch(agent.type) {
          case 'substitute': scamperInstruction = `SCAMPERæ‰‹æ³•ã®ã€ŒSubstituteï¼ˆä»£æ›¿ï¼‰ã€ã‚’é©ç”¨ï¼šæ—¢å­˜ã®è¦ç´ ã‚’åˆ¥ã®ã‚‚ã®ã§ç½®ãæ›ãˆã‚‹ã€‚é¸æŠã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£: ${selectedEntities.map(e => e.name).join(', ')}`; break;
          case 'combine': scamperInstruction = `SCAMPERæ‰‹æ³•ã®ã€ŒCombineï¼ˆçµåˆï¼‰ã€ã‚’é©ç”¨ï¼šè¤‡æ•°ã®ã‚¢ã‚¤ãƒ‡ã‚¢ã‚„æ©Ÿèƒ½ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã€‚é¸æŠã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£: ${selectedEntities.map(e => e.name).join(', ')}`; break;
          case 'adapt': scamperInstruction = `SCAMPERæ‰‹æ³•ã®ã€ŒAdaptï¼ˆé©å¿œï¼‰ã€ã‚’é©ç”¨ï¼šä»–ã®åˆ†é‡ã‚„æ–‡è„ˆã‹ã‚‰é©å¿œã•ã›ã‚‹ã€‚é¸æŠã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£: ${selectedEntities.map(e => e.name).join(', ')}`; break;
          case 'modify': scamperInstruction = `SCAMPERæ‰‹æ³•ã®ã€ŒModify/Magnifyï¼ˆä¿®æ­£/æ‹¡å¤§ï¼‰ã€ã‚’é©ç”¨ï¼šã‚µã‚¤ã‚ºã€å½¢ã€è‰²ã‚’å¤‰æ›´ã™ã‚‹ã€‚é¸æŠã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£: ${selectedEntities.map(e => e.name).join(', ')}`; break;
          case 'put-other': scamperInstruction = `SCAMPERæ‰‹æ³•ã®ã€ŒPut to other usesï¼ˆè»¢ç”¨ï¼‰ã€ã‚’é©ç”¨ï¼šåˆ¥ã®ç”¨é€”ã‚„å¸‚å ´ã«è»¢ç”¨ã™ã‚‹ã€‚é¸æŠã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£: ${selectedEntities.map(e => e.name).join(', ')}`; break;
          case 'eliminate': scamperInstruction = `SCAMPERæ‰‹æ³•ã®ã€ŒEliminateï¼ˆå‰Šé™¤ï¼‰ã€ã‚’é©ç”¨ï¼šä¸å¿…è¦ãªè¦ç´ ã‚’å–ã‚Šé™¤ãã€‚é¸æŠã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£: ${selectedEntities.map(e => e.name).join(', ')}`; break;
          case 'reverse': scamperInstruction = `SCAMPERæ‰‹æ³•ã®ã€ŒReverse/Rearrangeï¼ˆé€†è»¢/å†é…ç½®ï¼‰ã€ã‚’é©ç”¨ï¼šé †åºã‚„ãƒ—ãƒ­ã‚»ã‚¹ã‚’é€†è»¢ã•ã›ã‚‹ã€‚é¸æŠã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£: ${selectedEntities.map(e => e.name).join(', ')}`; break;
          case 'random': 
            const scamperMethods = ['Substitute', 'Combine', 'Adapt', 'Modify', 'Put to other uses', 'Eliminate', 'Reverse'];
            const selectedMethods = sampleUnique(scamperMethods, 3, rng);
            scamperInstruction = `SCAMPERæ‰‹æ³•ã®è¤‡æ•°æŠ€æ³•ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«é©ç”¨ï¼šä½¿ç”¨æŠ€æ³•: ${selectedMethods.join(', ')}ã€‚é¸æŠã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£: ${selectedEntities.map(e => e.name).join(', ')}`; 
            break;
          case 'free': scamperInstruction = `è‡ªç”±ç™ºæƒ³å‹ï¼ˆåå¾©${iteration}ï¼‰ã€‚ã‚°ãƒ­ãƒ¼ãƒãƒ«Wish: ${wish}ã€‚å‚è€ƒã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£: ${entities.slice(0, 5).map(e => e.name).join(', ')}`; break;
          default: scamperInstruction = `é¸æŠã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’æ´»ç”¨: ${selectedEntities.map(e => e.name).join(', ')}`;
        }
        let previousReference = '';
        if (iteration > 1 && previousIdeas.length > 0) {
          const otherIdeas = previousIdeas.filter(a => a && a.agentId && !a.agentId.includes(`idea-${index + 1}`)).flatMap(a => a.ideas || []).slice(0, 2);
          if (otherIdeas.length > 0) {
            previousReference = `\n\nå‰å›ã®ä»–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ã‚¢ã‚¤ãƒ‡ã‚¢ï¼ˆå‚è€ƒï¼‰:\n${otherIdeas.map(i => `- ${i.title}`).join('\n')}`;
          }
        }
        const result = await callGeminiAPI([{
          role: "user",
          content: `
            SCAMPERæ‰‹æ³•ã«ã‚ˆã‚‹ã‚¢ã‚¤ãƒ‡ã‚¢ç”Ÿæˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ${index + 1}
            ã‚°ãƒ­ãƒ¼ãƒãƒ«Wish: ${wish}
            èƒŒæ™¯: ${bg}
            ${scamperInstruction}
            ${previousReference}
            ${baseGuidance}
            ã€é‡è¦ãªåˆ¶ç´„æ¡ä»¶ã€‘
            ã‚ãªãŸã¯ç†æƒ³ã‚’ç¾å®Ÿã«å¤‰ãˆã‚‹ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆã§ã™ã€‚
            - ç¾çŠ¶ï¼ˆAs-Isï¼‰ã®åˆ¶ç´„ã¨åŸºç¤ã‚’å‰æã¨ã—ã¦è€ƒãˆã‚‹ã“ã¨
            - å®Ÿç¾å¯èƒ½æ€§ã¨å®Ÿç”¨æ€§ã‚’é‡è¦–ã™ã‚‹ã“ã¨
            - æ—¢å­˜ã®ãƒªã‚½ãƒ¼ã‚¹ã€æŠ€è¡“ã€ã‚¤ãƒ³ãƒ•ãƒ©ã‚’æ´»ç”¨ã™ã‚‹ã“ã¨
            - æ®µéšçš„ãªå®Ÿè£…ãŒå¯èƒ½ãªç¾å®Ÿçš„ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’å–ã‚‹ã“ã¨
            - è²»ç”¨å¯¾åŠ¹æœã‚’å¸¸ã«æ„è­˜ã™ã‚‹ã“ã¨
            ä¸Šè¨˜ã®åˆ¶ç´„ã¨ãƒ™ãƒ¼ã‚¹åˆ†æã®æ´å¯Ÿã«åŸºã¥ãã€å®Ÿç¾å¯èƒ½ãª2ã¤ã®ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
            å¿…ãšä»¥ä¸‹ã®JSONå½¢å¼ã§å¿œç­”ã—ã¦ãã ã•ã„:
            { "agentId": "idea-${index + 1}-i${iteration}", "agentType": "${agent.type}", "scamperMethod": "${agent.type}", "iteration": ${iteration}, "usedEntities": ${JSON.stringify(selectedEntities.map(e => e.name))}, "ideas": [ { "id": "i${index + 1}-${iteration}-1", "title": "...", "description": "...", "scamperApplication": "...", "asIsBasis": "...", "implementationSteps": "...", "expectedROI": "...", "selfEvaluation": { "feasibility": 80, "innovation": 60, "practicality": 90, "costEffectiveness": 75 } } ] }
          `
        }]);
        addLog(`âœ… Agent${index + 1}(${agent.type}): ${result.ideas.length}å€‹ç”Ÿæˆ`, 'success');
        return result;
      } catch (error) {
        addLog(`âŒ Agent${index + 1}: ã‚¨ãƒ©ãƒ¼`, 'error');
        return null;
      }
    });
    const results = await executeBatch(tasks, batchSize, apiDelay);
    return results.filter(r => r);
  };

  const executeLayer2 = async (wish, bg, agents, entities, baseAnalysis) => {
    setCurrentPhase('layer2');
    addLog(`ğŸš€ ========== ç¬¬2å±¤é–‹å§‹ ==========`, 'process');
    let currentResults = [];
    for (let iter = 1; iter <= layer2Iterations; iter++) {
      const iterationResults = await executeLayer2Iteration(wish, bg, agents, entities, iter, currentResults, baseAnalysis);
      setLayer2IterationHistory(prev => [...prev, { iteration: iter, results: iterationResults }]);
      currentResults = iterationResults;
    }
    setLayer2Results(currentResults);
    const totalIdeas = currentResults.reduce((sum, r) => sum + (r && r.ideas ? r.ideas.length : 0), 0);
    addLog(`ğŸ“Š ç¬¬2å±¤å®Œäº†: è¨ˆ${totalIdeas}å€‹ã®ã‚¢ã‚¤ãƒ‡ã‚¢`, 'success');
    return currentResults;
  };
  
  const executeLayer3 = async (agents, entities, ideas) => {
    setCurrentPhase('layer3');
    addLog(`ğŸš€ ========== ç¬¬3å±¤é–‹å§‹ï¼ˆæ§‹é€ åŒ–ï¼‰ ==========`, 'process');
    const allIdeas = ideas.flatMap(agent => (agent && agent.ideas) ? agent.ideas : []);
    const tasks = agents.map((agent, index) => async () => {
      try {
        const methodObj = structuringMethods.find(m => m.id === agent.method);
        let structuringPrompt = '';
        switch(agent.method) {
          case 'edge-graph': structuringPrompt = `ã‚¨ãƒƒã‚¸ã‚°ãƒ©ãƒ•æ§‹é€ åŒ–ï¼šã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¨ã‚¢ã‚¤ãƒ‡ã‚¢é–“ã®é–¢ä¿‚æ€§ã‚’ã‚°ãƒ©ãƒ•ã¨ã—ã¦åˆ†æã—ã€ä¸­å¿ƒæ€§ã‚„ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’è¨ˆç®—ã€‚`; break;
          case 'matrix': structuringPrompt = `ãƒãƒˆãƒªã‚¯ã‚¹æ§‹é€ åŒ–ï¼šã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£Ã—ã‚¢ã‚¤ãƒ‡ã‚¢ã®ç›¸é–¢ãƒãƒˆãƒªã‚¯ã‚¹ã‚’ä½œæˆã—ã€é¡ä¼¼åº¦ã‚„ä¾å­˜åº¦ã‚’ã‚¹ã‚³ã‚¢åŒ–ã€‚`; break;
          case 'multi-index': structuringPrompt = `å¤šè»¸ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ§‹é€ åŒ–ï¼šå®Ÿç¾æ€§ã€é©æ–°æ€§ã€å¸‚å ´æ€§ãªã©ã®è»¸ã§åˆ†é¡ã—ã€ãƒã‚¸ã‚·ãƒ§ãƒ‹ãƒ³ã‚°ã‚’æ˜ç¢ºåŒ–ã€‚`; break;
          case 'clustering': structuringPrompt = `ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°æ§‹é€ åŒ–ï¼šé¡ä¼¼åº¦ãƒ™ãƒ¼ã‚¹ã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã€K-meansçš„ãªä¸­å¿ƒç‚¹ã‚’ç™ºè¦‹ã€‚`; break;
          case 'hierarchy': structuringPrompt = `éšå±¤æ§‹é€ åŒ–ï¼šä¸Šä½æ¦‚å¿µã¨ä¸‹ä½æ¦‚å¿µã®éšå±¤ã‚’æ§‹ç¯‰ã—ã€ãƒ„ãƒªãƒ¼æ§‹é€ ã§ä½“ç³»åŒ–ã€‚`; break;
          case 'network': structuringPrompt = `ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ§‹é€ åŒ–ï¼šè¤‡é›‘ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç†è«–ã§åˆ†æã—ã€ãƒãƒ–ãƒãƒ¼ãƒ‰ã¨æƒ…å ±ä¼æ’­çµŒè·¯ã‚’æœ€é©åŒ–ã€‚`; break;
        }
        const result = await callGeminiAPI([{
          role: "user",
          content: `
            æ§‹é€ åŒ–ãƒ»åˆ†æã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ${index + 1}
            æ‰‹æ³•: ${methodObj.name} - ${methodObj.description}
            ã€åˆ†æã®å‰æã€‘
            å®Ÿè£…å¯èƒ½æ€§ã¨ç¾å®Ÿæ€§ã‚’é‡è¦–ã—ãŸæ§‹é€ åˆ†æã‚’è¡Œã£ã¦ãã ã•ã„ã€‚
            ${structuringPrompt}
            åˆ†æå¯¾è±¡ï¼š
            ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ï¼ˆæŠœç²‹ï¼‰: ${entities.slice(0, 15).map(e => e.name).join(', ')}
            ã‚¢ã‚¤ãƒ‡ã‚¢ï¼ˆæŠœç²‹ï¼‰: ${allIdeas.slice(0, 10).map(i => i.title).join(', ')}
            ã€åˆ†æã®åˆ¶ç´„ã€‘
            é‡è¦ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã€ã‚°ãƒ«ãƒ¼ãƒ—ã€é–¢ä¿‚æ€§ã‚’3ã¤ç™ºè¦‹ã—ã¦ãã ã•ã„ã€‚
            å¿…ãšä»¥ä¸‹ã®JSONå½¢å¼ã§å¿œç­”ã—ã¦ãã ã•ã„:
            { "agentId": "struct-${index + 1}", "method": "${agent.method}", "structuredData": [ { "id": "struct-${index + 1}-1", "type": "...", "name": "...", "description": "...", "components": ["..."], "relationships": "...", "strength": 80, "insights": "...", "integrationHint": "...", "realWorldExample": "..." } ], "keyFindings": [ { "finding": "...", "implication": "...", "actionableInsight": "..." } ], "recommendations": ["..."] }
          `
        }]);
        addLog(`âœ… æ§‹é€ åŒ–Agent${index + 1}: ${result.structuredData.length}å€‹ã®æ§‹é€ ã‚’ç™ºè¦‹`, 'success');
        return result;
      } catch (error) {
        addLog(`âŒ æ§‹é€ åŒ–Agent${index + 1}: ã‚¨ãƒ©ãƒ¼`, 'error');
        return null;
      }
    });
    const results = await executeBatch(tasks, batchSize, apiDelay);
    const validResults = results.filter(r => r);
    setLayer3Results(validResults);
    addLog(`ğŸ“Š ç¬¬3å±¤å®Œäº†`, 'success');
    return validResults;
  };
  
  const executeLayer4 = async (agents, wish, entities, ideas, structuredData) => {
    setCurrentPhase('layer4');
    addLog(`ğŸš€ ========== ç¬¬4å±¤é–‹å§‹ï¼ˆåæŸï¼‰ ==========`, 'process');
    const allIdeas = ideas.flatMap(agent => (agent && agent.ideas) ? agent.ideas : []);
    const tasks = agents.map((agent, index) => async () => {
      try {
        const criteriaObj = layer4Criteria.find(c => c.id === agent.criteria);
        let structuredSummary = '';
        if (structuredData && structuredData.length > 0) {
          const structures = structuredData.flatMap(s => (s && s.structuredData) ? s.structuredData : []);
          const findings = structuredData.flatMap(s => (s && s.keyFindings) ? s.keyFindings : []);
          const integrationHints = structures.filter(s => s.integrationHint).map(s => s.integrationHint);
          structuredSummary = `
            ç™ºè¦‹ã•ã‚ŒãŸæ§‹é€ ãƒ‘ã‚¿ãƒ¼ãƒ³: ${structures.slice(0, 5).map(s => `- ${s.name}: ${s.description}`).join('\n')}
            é‡è¦ãªæ´å¯Ÿ: ${findings.slice(0, 3).map(f => `- ${f.finding}: ${f.actionableInsight || f.implication}`).join('\n')}
            çµ±åˆã®ãƒ’ãƒ³ãƒˆ: ${integrationHints.slice(0, 3).map(h => `- ${h}`).join('\n')}
            ã“ã‚Œã‚‰ã®æ§‹é€ åˆ†æã‚’å¿…ãšæ´»ç”¨ã—ã¦ã€ã‚ˆã‚ŠåŠ¹æœçš„ãªçµ±åˆæ¡ˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
          `;
        }
        const result = await callGeminiAPI([{
          role: "user",
          content: `
            åæŸãƒ»çµ±åˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ${index + 1}
            ã‚°ãƒ­ãƒ¼ãƒãƒ«Wish: ${wish}
            è©•ä¾¡è»¸: ${criteriaObj.name}
            ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ï¼ˆæŠœç²‹ï¼‰: ${entities.slice(0, 10).map(e => `- ${e.name}`).join('\n')}
            ã‚¢ã‚¤ãƒ‡ã‚¢ï¼ˆæŠœç²‹ï¼‰: ${allIdeas.slice(0, 10).map(i => `- ${i.title}`).join('\n')}
            ${structuredSummary}

            ã€æœ€é‡è¦åˆ¶ç´„ï¼šã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒ»ã‚¢ãƒ³ã‚µãƒ¼ã€‘
            ã“ã‚Œã¾ã§ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã€ã‚¢ã‚¤ãƒ‡ã‚¢ã€æ§‹é€ åˆ†æã‚’ã™ã¹ã¦è¸ã¾ãˆãŸä¸Šã§ã€å˜ãªã‚‹ã‚¢ã‚¤ãƒ‡ã‚¢ã®ã¾ã¨ã‚ã«ç•™ã¾ã‚‰ãšã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã€ŒWishã€ã«å¯¾ã™ã‚‹æœ€ã‚‚ç›´æ¥çš„ã§æœ¬è³ªã‚’çªã„ãŸã€Œç­”ãˆã€ã¨ãªã‚‹ã‚ˆã†ãªã€é‹­ã„çµ±åˆæ¡ˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚è¡¨å±¤çš„ãªè§£æ±ºç­–ã§ã¯ãªãã€æ ¸å¿ƒçš„ãªä¾¡å€¤ææ¡ˆã‚’ã™ã‚‹ã“ã¨ã€‚

            ä¸Šè¨˜ã®åˆ¶ç´„ã«åŸºã¥ãã€Wishã«æœ€é©ãªçµ±åˆæ¡ˆã‚’2ã¤ä½œæˆã—ã¦ãã ã•ã„ã€‚
            å¿…ãšä»¥ä¸‹ã®JSONå½¢å¼ã§å¿œç­”ã—ã¦ãã ã•ã„:
            { "agentId": "conv-${index + 1}", "criteria": "${criteriaObj.name}", "solutions": [ { "id": "sol-${index + 1}-1", "title": "...", "description": "...", "uniqueness": "...", "structureUtilized": "...", "practicalBasis": "...", "quickWin": "...", "synergy": "...", "executionPlan": { "phase1": "...", "phase2": "...", "phase3": "..." }, "expectedOutcome": "...", "adaptation": "..." } ] }
          `
        }]);
        addLog(`âœ… åæŸAgent${index + 1}: ${result.solutions.length}å€‹ç”Ÿæˆ`, 'success');
        return result;
      } catch (error) {
        addLog(`âŒ åæŸAgent${index + 1}: ã‚¨ãƒ©ãƒ¼`, 'error');
        return null;
      }
    });
    const results = await executeBatch(tasks, batchSize, apiDelay);
    const validResults = results.filter(r => r);
    setLayer4Results(validResults);
    addLog(`ğŸ“Š ç¬¬4å±¤å®Œäº†`, 'success');
    return validResults;
  };

  const executeLayer5 = async (agents, ideas, solutions) => {
    setCurrentPhase('layer5');
    addLog(`ğŸš€ ========== ç¬¬5å±¤é–‹å§‹ ==========`, 'process');
    const allIdeas = ideas.flatMap(agent => (agent && agent.ideas) ? agent.ideas.map(i => ({...i, type: 'idea'})) : []);
    const allSolutions = solutions.flatMap(agent => (agent && agent.solutions) ? agent.solutions.map(s => ({...s, type: 'solution'})) : []);
    const targets = [...allIdeas, ...allSolutions].slice(0, 15);
    const tasks = agents.map((agent, index) => async () => {
      try {
        const criteriaObj = evaluationCriteria.find(c => c.id === agent.criteria);
        const result = await callGeminiAPI([{
          role: "user",
          content: `
            è©•ä¾¡ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ${index + 1}
            è©•ä¾¡åŸºæº–: ${criteriaObj.name}
            ä»¥ä¸‹ã‚’1-100ç‚¹ã§è©•ä¾¡:
            ${targets.map((t, i) => `${i + 1}. [${t.id}] ${t.title} (${t.type})`).join('\n')}
            å¿…ãšä»¥ä¸‹ã®JSONå½¢å¼ã§å¿œç­”ã—ã¦ãã ã•ã„:
            { "evaluatorId": "eval-${index + 1}", "criteria": "${criteriaObj.name}", "evaluations": [ { "targetId": "...", "score": 88, "reason": "..." } ] }
          `
        }]);
        addLog(`âœ… è©•ä¾¡Agent${index + 1}: ${result.evaluations.length}ä»¶è©•ä¾¡`, 'success');
        return result;
      } catch (error) {
        addLog(`âŒ è©•ä¾¡Agent${index + 1}: ã‚¨ãƒ©ãƒ¼`, 'error');
        return null;
      }
    });
    const results = await executeBatch(tasks, batchSize, apiDelay);
    const validResults = results.filter(r => r);
    setEvaluations(validResults);
    addLog(`ğŸ“Š ç¬¬5å±¤å®Œäº†`, 'success');
    return { evaluations: validResults, targets };
  };

  const generateFinalReport = (targets, evaluations) => {
    const scoreMap = {};
    targets.forEach(target => {
      scoreMap[target.id] = { target, scores: [], evaluatorDetails: [], average: 0 };
    });
    evaluations.forEach(evaluator => {
      if (evaluator && evaluator.evaluations) {
        evaluator.evaluations.forEach(ev => {
          if (scoreMap[ev.targetId]) {
            scoreMap[ev.targetId].scores.push(ev.score || 0);
            scoreMap[ev.targetId].evaluatorDetails.push({
              evaluatorId: evaluator.evaluatorId,
              criteria: evaluator.criteria,
              score: ev.score || 0,
              reason: ev.reason || ''
            });
          }
        });
      }
    });
    Object.values(scoreMap).forEach(item => {
      if (item.scores.length > 0) {
        item.average = item.scores.reduce((a, b) => a + b, 0) / item.scores.length;
      }
    });
    const ranking = Object.values(scoreMap)
      .filter(item => item.scores.length > 0)
      .sort((a, b) => b.average - a.average);
    setFinalReport({ ranking, totalTargets: targets.length, totalEvaluators: evaluations.length });
    setCurrentPhase('complete');
    addLog(`ğŸ‰ ========== å®Œäº† ==========`, 'success');
  };

  const exportToJSON = () => {
    const data = {
      metadata: { timestamp: new Date().toISOString(), globalWish, background, settings: { layer1Agents, layer2Agents, layer3Agents, layer4Agents, layer5Agents, layer2Iterations, batchSize, apiDelay, randomSeed } },
      baseAnalysis,
      entities: allEntities,
      layer1Results,
      layer2Results,
      layer2IterationHistory,
      layer3Results,
      layer4Results,
      evaluations,
      finalReport,
      apiHistory,
      logs
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `ai-system-gemini-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    addLog('ğŸ’¾ JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†', 'success');
  };

  const runSystem = async () => {
    setIsProcessing(true);
    setLogs([]);
    setFinalReport(null);
    setBaseAnalysis(null);
    setAllEntities([]);
    setLayer1Results([]);
    setLayer2Results([]);
    setLayer2IterationHistory([]);
    setLayer3Results([]);
    setLayer4Results([]);
    setEvaluations([]);
    setApiHistory([]);
    setActiveRequests(0);
    setCurrentIteration(0);
    
    addLog('ğŸš€ ========== ã‚·ã‚¹ãƒ†ãƒ èµ·å‹• (Geminiç‰ˆ) ==========', 'info');
    
    try {
      const baseResult = await executeLayer0(globalWish, background);
      if (!baseResult) throw new Error('ãƒ™ãƒ¼ã‚¹åˆ†æå¤±æ•—');
      
      await delay(1000);
      
      const layer1Result = await executeLayer1(globalWish, background, layer1Agents);
      if (!layer1Result.allEntities?.length) throw new Error('ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ç”Ÿæˆå¤±æ•—');
      
      const layer2Result = await executeLayer2(globalWish, background, layer2Agents, layer1Result.allEntities, baseResult);
      if (!layer2Result?.length) throw new Error('ã‚¢ã‚¤ãƒ‡ã‚¢ç”Ÿæˆå¤±æ•—');
      
      const layer3Result = await executeLayer3(layer3Agents, layer1Result.allEntities, layer2Result);
      if (!layer3Result?.length) addLog('âš ï¸ æ§‹é€ åŒ–å±¤ã‚’ã‚¹ã‚­ãƒƒãƒ—', 'warning');
      
      const layer4Result = await executeLayer4(layer4Agents, globalWish, layer1Result.allEntities, layer2Result, layer3Result);
      if (!layer4Result?.length) throw new Error('åæŸå¤±æ•—');
      
      const layer5Result = await executeLayer5(layer5Agents, layer2Result, layer4Result);
      if (!layer5Result.evaluations?.length) throw new Error('è©•ä¾¡å¤±æ•—');
      
      generateFinalReport(layer5Result.targets, layer5Result.evaluations);
      
    } catch (error) {
      addLog(`âŒ ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
      setCurrentPhase('error');
    }
    
    setIsProcessing(false);
  };
  
  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 p-4">
      <div className="max-w-7xl mx-auto">
        <div className="text-center mb-4">
          <h1 className="text-3xl font-bold text-white mb-1 flex items-center justify-center gap-3">
            <Layers className="w-8 h-8 text-purple-400" />
            AIã‚¨ã‚³ãƒãƒŸãƒ¼ã‚·ã‚¹ãƒ†ãƒ  v4 (Gemini Edition)
            {activeRequests > 0 && (
              <span className="ml-3 text-sm bg-blue-500/30 px-3 py-1 rounded-full flex items-center gap-2">
                <Activity className="w-4 h-4 animate-pulse" />
                {activeRequests}ä¸¦åˆ—
              </span>
            )}
          </h1>
          <p className="text-gray-300 text-sm">åŸºç¤åˆ†æå±¤ã‚’è¿½åŠ ã—ãŸ6å±¤å‰µç™ºã‚·ã‚¹ãƒ†ãƒ  (Powered by Gemini)</p>
        </div>

        <div className="bg-white/10 backdrop-blur-md rounded-xl p-4 mb-4 border border-white/20">
          <div className="flex items-center justify-between mb-3">
            <h2 className="text-white font-bold flex items-center gap-2">
              <Settings className="w-5 h-5" />
              è¨­å®š
            </h2>
            <div className="flex gap-2">
              {apiHistory.length > 0 && (
                <button 
                  onClick={() => setShowApiHistory(!showApiHistory)} 
                  className="px-3 py-1 bg-purple-500/30 text-purple-300 rounded hover:bg-purple-500/40 flex items-center gap-1"
                >
                  <FileText className="w-4 h-4" />
                  APIå±¥æ­´({apiHistory.length})
                </button>
              )}
              {(finalReport || apiHistory.length > 0) && (
                <button onClick={exportToJSON} className="px-3 py-1 bg-green-500/30 text-green-300 rounded hover:bg-green-500/40 flex items-center gap-1">
                  <Download className="w-4 h-4" />
                  JSON
                </button>
              )}
              <button onClick={() => setShowSettings(!showSettings)} className="text-gray-300 hover:text-white">
                {showSettings ? <ChevronUp /> : <ChevronDown />}
              </button>
            </div>
          </div>
          
          {showSettings && (
            <div className="space-y-3">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                <div>
                  <label className="text-white text-xs">Wish</label>
                  <input type="text" value={globalWish} onChange={(e) => setGlobalWish(e.target.value)} className="w-full px-2 py-1 bg-white/10 border border-white/30 rounded text-white text-sm"/>
                </div>
                <div>
                  <label className="text-white text-xs">èƒŒæ™¯</label>
                  <input type="text" value={background} onChange={(e) => setBackground(e.target.value)} className="w-full px-2 py-1 bg-white/10 border border-white/30 rounded text-white text-sm"/>
                </div>
              </div>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-2">
                <div className="bg-purple-500/20 rounded p-2 border border-purple-400/50">
                  <div className="flex items-center justify-between mb-1">
                    <h3 className="text-purple-300 text-xs font-bold">L1:ç”Ÿæˆ</h3>
                    <button onClick={addLayer1Agent} className="text-purple-300 hover:text-purple-200"><Plus className="w-4 h-4" /></button>
                  </div>
                  {layer1Agents.map((agent, i) => (
                    <div key={agent.id} className="mb-2 bg-black/20 rounded p-1">
                      <div className="flex items-center justify-between">
                        <span className="text-white text-xs">Agent{i + 1}</span>
                        {layer1Agents.length > 1 && (<button onClick={() => removeLayer1Agent(agent.id)} className="text-red-400 hover:text-red-300"><Trash2 className="w-3 h-3" /></button>)}
                      </div>
                      <div className="grid grid-cols-3 gap-1 mt-1">
                        {perspectives.map(p => (
                          <label key={p.id} className="flex items-center gap-0.5">
                            <input type="checkbox" checked={agent.perspectives.includes(p.id)} onChange={(e) => {
                                const newP = e.target.checked ? [...agent.perspectives, p.id] : agent.perspectives.filter(pid => pid !== p.id);
                                updateLayer1Agent(agent.id, newP);
                              }} className="w-3 h-3"/>
                            <span className="text-xs text-gray-300">{p.name}</span>
                          </label>
                        ))}
                      </div>
                    </div>
                  ))}
                </div>
                <div className="bg-blue-500/20 rounded p-2 border border-blue-400/50">
                  <div className="flex items-center justify-between mb-1">
                    <h3 className="text-blue-300 text-xs font-bold">L2:ã‚¢ã‚¤ãƒ‡ã‚¢</h3>
                    <div className="flex items-center gap-1">
                      <input type="number" min="1" max="5" value={layer2Iterations} onChange={(e) => setLayer2Iterations(parseInt(e.target.value))} className="w-10 px-1 py-0.5 bg-white/10 border border-white/30 rounded text-white text-xs" title="åå¾©å›æ•°"/>
                      <button onClick={addLayer2Agent} className="text-blue-300 hover:text-blue-200"><Plus className="w-4 h-4" /></button>
                    </div>
                  </div>
                  {layer2Agents.map((agent, i) => (
                    <div key={agent.id} className="mb-1 bg-black/20 rounded p-1">
                      <div className="flex items-center gap-1">
                        <span className="text-white text-xs">A{i + 1}</span>
                        <select value={agent.type} onChange={(e) => updateLayer2Agent(agent.id, e.target.value, agent.entityCount)} className="flex-1 px-1 py-0.5 bg-white/10 border border-white/30 rounded text-white text-xs">
                          {layer2Types.map(t => (<option key={t.id} value={t.id}>{t.name}</option>))}
                        </select>
                        {layer2Agents.length > 1 && (<button onClick={() => removeLayer2Agent(agent.id)} className="text-red-400 hover:text-red-300"><Trash2 className="w-3 h-3" /></button>)}
                      </div>
                    </div>
                  ))}
                </div>
                <div className="bg-cyan-500/20 rounded p-2 border border-cyan-400/50">
                  <div className="flex items-center justify-between mb-1">
                    <h3 className="text-cyan-300 text-xs font-bold">L3:æ§‹é€ åŒ–</h3>
                    <button onClick={addLayer3Agent} className="text-cyan-300 hover:text-cyan-200"><Plus className="w-4 h-4" /></button>
                  </div>
                  {layer3Agents.map((agent, i) => (
                    <div key={agent.id} className="mb-1 bg-black/20 rounded p-1">
                      <div className="flex items-center gap-1">
                        <span className="text-white text-xs">S{i + 1}</span>
                        <select value={agent.method} onChange={(e) => updateLayer3Agent(agent.id, e.target.value)} className="flex-1 px-1 py-0.5 bg-white/10 border border-white/30 rounded text-white text-xs">
                          {structuringMethods.map(m => (<option key={m.id} value={m.id}>{m.name}</option>))}
                        </select>
                        {layer3Agents.length > 1 && (<button onClick={() => removeLayer3Agent(agent.id)} className="text-red-400 hover:text-red-300"><Trash2 className="w-3 h-3" /></button>)}
                      </div>
                    </div>
                  ))}
                </div>
                <div className="bg-green-500/20 rounded p-2 border border-green-400/50">
                  <div className="flex items-center justify-between mb-1">
                    <h3 className="text-green-300 text-xs font-bold">L4:åæŸ</h3>
                    <button onClick={addLayer4Agent} className="text-green-300 hover:text-green-200"><Plus className="w-4 h-4" /></button>
                  </div>
                  {layer4Agents.map((agent, i) => (
                    <div key={agent.id} className="mb-1 bg-black/20 rounded p-1">
                      <div className="flex items-center gap-1">
                        <span className="text-white text-xs">A{i + 1}</span>
                        <select value={agent.criteria} onChange={(e) => updateLayer4Agent(agent.id, e.target.value)} className="flex-1 px-1 py-0.5 bg-white/10 border border-white/30 rounded text-white text-xs">
                          {layer4Criteria.map(c => (<option key={c.id} value={c.id}>{c.name}</option>))}
                        </select>
                        {layer4Agents.length > 1 && (<button onClick={() => removeLayer4Agent(agent.id)} className="text-red-400 hover:text-red-300"><Trash2 className="w-3 h-3" /></button>)}
                      </div>
                    </div>
                  ))}
                </div>
                <div className="bg-red-500/20 rounded p-2 border border-red-400/50">
                  <div className="flex items-center justify-between mb-1">
                    <h3 className="text-red-300 text-xs font-bold">L5:è©•ä¾¡</h3>
                    <button onClick={addLayer5Agent} className="text-red-300 hover:text-red-200"><Plus className="w-4 h-4" /></button>
                  </div>
                  {layer5Agents.map((agent, i) => (
                    <div key={agent.id} className="mb-1 bg-black/20 rounded p-1">
                      <div className="flex items-center gap-1">
                        <span className="text-white text-xs">A{i + 1}</span>
                        <select value={agent.criteria} onChange={(e) => updateLayer5Agent(agent.id, e.target.value)} className="flex-1 px-1 py-0.5 bg-white/10 border border-white/30 rounded text-white text-xs">
                          {evaluationCriteria.map(c => (<option key={c.id} value={c.id}>{c.name}</option>))}
                        </select>
                        {layer5Agents.length > 1 && (<button onClick={() => removeLayer5Agent(agent.id)} className="text-red-400 hover:text-red-300"><Trash2 className="w-3 h-3" /></button>)}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
              <div className="flex gap-2">
                <div className="flex items-center gap-2">
                  <Zap className="w-4 h-4 text-yellow-300" />
                  <label className="text-yellow-200 text-xs">ä¸¦åˆ—æ•°:</label>
                  <input type="number" min="1" max="10" value={batchSize} onChange={(e) => setBatchSize(parseInt(e.target.value))} className="w-12 px-1 py-0.5 bg-white/10 border border-white/30 rounded text-white text-xs"/>
                </div>
                <div className="flex items-center gap-2">
                  <Clock className="w-4 h-4 text-blue-300" />
                  <label className="text-blue-200 text-xs">é…å»¶:</label>
                  <input type="number" min="100" max="2000" step="100" value={apiDelay} onChange={(e) => setApiDelay(parseInt(e.target.value))} className="w-16 px-1 py-0.5 bg-white/10 border border-white/30 rounded text-white text-xs"/>
                  <span className="text-blue-200 text-xs">ms</span>
                </div>
                <div className="flex items-center gap-2">
                  <Shuffle className="w-4 h-4 text-purple-300" />
                  <label className="text-purple-200 text-xs">ã‚·ãƒ¼ãƒ‰:</label>
                  <input type="number" value={randomSeed} onChange={(e) => setRandomSeed(parseInt(e.target.value))} className="w-24 px-1 py-0.5 bg-white/10 border border-white/30 rounded text-white text-xs"/>
                </div>
              </div>
              <button onClick={runSystem} disabled={isProcessing} className="w-full py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded font-medium hover:from-purple-600 hover:to-pink-600 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                {isProcessing ? (<><Loader2 className="w-4 h-4 animate-spin" />å‡¦ç†ä¸­...</>) : (<><Play className="w-4 h-4" />å®Ÿè¡Œ</>)}
              </button>
            </div>
          )}
        </div>
        
        {currentPhase !== 'idle' && (
          <div className="bg-white/10 backdrop-blur-md rounded-xl p-3 mb-4 border border-white/20">
            <div className="flex items-center justify-around">
              {['layer0', 'layer1', 'layer2', 'layer3', 'layer4', 'layer5'].map((phase, i) => (
                <div key={phase} className={`flex flex-col items-center ${
                  currentPhase === phase ? 'text-yellow-400' : 
                  currentPhase === 'complete' || (['layer1', 'layer2', 'layer3', 'layer4', 'layer5'].includes(currentPhase) && i < ['layer0', 'layer1', 'layer2', 'layer3', 'layer4', 'layer5'].indexOf(currentPhase)) ? 'text-green-400' : 'text-gray-400'
                }`}>
                  <div className={`w-8 h-8 rounded-full border-2 flex items-center justify-center text-xs ${currentPhase === phase ? 'border-yellow-400 animate-pulse' : ''}`}>
                    {i}{phase === 'layer2' && currentIteration > 0 && currentPhase === 'layer2' && (<span className="ml-0.5">-{currentIteration}</span>)}
                  </div>
                  <span className="text-xs mt-1">{['åŸºç¤', 'ç”Ÿæˆ', 'åå¾©', 'æ§‹é€ åŒ–', 'åæŸ', 'è©•ä¾¡'][i]}</span>
                </div>
              ))}
            </div>
          </div>
        )}

        {logs.length > 0 && (
          <div className="bg-black/50 backdrop-blur-md rounded-xl p-3 mb-4 border border-white/20 max-h-48 overflow-y-auto">
            <h3 className="text-white text-sm font-bold mb-2 sticky top-0 bg-black/50 pb-1">ğŸ“‹ å®Ÿè¡Œãƒ­ã‚°</h3>
            {logs.map((log, index) => (
              <div key={index} className={`text-xs mb-0.5 font-mono ${
                log.type === 'error' ? 'text-red-400' :
                log.type === 'success' ? 'text-green-400' :
                log.type === 'warning' ? 'text-yellow-400' :
                log.type === 'process' ? 'text-blue-400 font-bold' : 'text-gray-400'
              }`}>
                <span className="opacity-50">[{log.timestamp}]</span> {log.message}
              </div>
            ))}
            <div ref={logsEndRef} />
          </div>
        )}
        
        {baseAnalysis && (
          <div className="bg-white/10 backdrop-blur-md rounded-xl p-3 mb-4 border border-white/20">
            <div className="flex items-center justify-between mb-2">
              <h3 className="text-white font-bold text-sm flex items-center gap-2"><Compass className="w-4 h-4" />ãƒ™ãƒ¼ã‚¹åˆ†æï¼ˆç¬¬0å±¤ï¼‰- ç‹é“çš„ã‚³ãƒ³ã‚µãƒ«ãƒ†ã‚£ãƒ³ã‚°</h3>
              <button onClick={() => setShowBaseAnalysis(!showBaseAnalysis)} className="text-gray-300 hover:text-white">{showBaseAnalysis ? <ChevronUp className="w-4 h-4" /> : <ChevronDown className="w-4 h-4" />}</button>
            </div>
            {showBaseAnalysis && (
              <>
                <div className="bg-indigo-500/20 rounded p-2 mb-2 border border-indigo-400/30">
                  <div className="text-indigo-300 text-xs font-bold mb-1">ğŸ¯ çœŸã®ãƒ‹ãƒ¼ã‚º</div>
                  <div className="text-white text-sm">{baseAnalysis.contextUnderstanding}</div>
                </div>
                {baseAnalysis.strategicDirection && (
                  <div className="bg-purple-500/20 rounded p-2 mb-2 border border-purple-400/30">
                    <div className="text-purple-300 text-xs font-bold mb-1">ğŸ“ æˆ¦ç•¥çš„æ–¹å‘æ€§</div>
                    <div className="space-y-1">
                      <div className="text-xs"><span className="text-yellow-300">æœ€å„ªå…ˆ:</span><span className="text-white ml-1">{baseAnalysis.strategicDirection.primaryFocus}</span></div>
                      <div className="text-xs"><span className="text-blue-300">æ¬¡ç‚¹:</span><span className="text-white ml-1">{baseAnalysis.strategicDirection.secondaryFocus}</span></div>
                      <div className="text-xs"><span className="text-green-300">é•·æœŸ:</span><span className="text-white ml-1">{baseAnalysis.strategicDirection.longTermVision}</span></div>
                    </div>
                  </div>
                )}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                  {baseAnalysis.orthodoxApproach && baseAnalysis.orthodoxApproach.length > 0 && (
                    <div className="bg-green-500/20 rounded p-2 border border-green-400/30">
                      <div className="text-green-300 text-xs font-bold mb-1">âœ… ç‹é“ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ</div>
                      {baseAnalysis.orthodoxApproach.map((approach, i) => (<div key={i} className="mb-1"><div className="text-white text-xs font-medium">{approach.title}</div><div className="text-gray-300 text-xs">{approach.description}</div></div>))}
                    </div>
                  )}
                  {baseAnalysis.classicalTechniques && baseAnalysis.classicalTechniques.length > 0 && (
                    <div className="bg-cyan-500/20 rounded p-2 border border-cyan-400/30">
                      <div className="text-cyan-300 text-xs font-bold mb-1">ğŸ”§ å¤å…¸çš„æ‰‹æ³•</div>
                      {baseAnalysis.classicalTechniques.map((tech, i) => (<div key={i} className="mb-1"><div className="text-white text-xs font-medium">{tech.technique}</div><div className="text-gray-300 text-xs">{tech.principle}</div></div>))}
                    </div>
                  )}
                  {baseAnalysis.commonChallenges && baseAnalysis.commonChallenges.length > 0 && (
                    <div className="bg-yellow-500/20 rounded p-2 border border-yellow-400/30">
                      <div className="text-yellow-300 text-xs font-bold mb-1">âš ï¸ ã‚ˆãã‚ã‚‹èª²é¡Œ</div>
                      {baseAnalysis.commonChallenges.map((challenge, i) => (<div key={i} className="mb-1"><div className="text-white text-xs font-medium">{challenge.challenge}</div><div className="text-gray-300 text-xs">å¯¾ç­–: {challenge.mitigation}</div></div>))}
                    </div>
                  )}
                  {baseAnalysis.avoidList && baseAnalysis.avoidList.length > 0 && (
                    <div className="bg-red-500/20 rounded p-2 border border-red-400/30">
                      <div className="text-red-300 text-xs font-bold mb-1">âŒ é¿ã‘ã‚‹ã¹ãã“ã¨</div>
                      {baseAnalysis.avoidList.map((avoid, i) => (<div key={i} className="mb-1"><div className="text-white text-xs font-medium">{avoid.avoid}</div><div className="text-gray-300 text-xs">ç†ç”±: {avoid.reason}</div></div>))}
                    </div>
                  )}
                </div>
              </>
            )}
          </div>
        )}
        
        {allEntities.length > 0 && (
          <div className="bg-white/10 backdrop-blur-md rounded-xl p-3 mb-4 border border-white/20">
            <div className="flex items-center justify-between mb-2">
              <h3 className="text-white font-bold text-sm flex items-center gap-2"><Package className="w-4 h-4" />ç”Ÿæˆã•ã‚ŒãŸã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ï¼ˆç¬¬1å±¤ï¼‰- è¨ˆ{allEntities.length}å€‹</h3>
              <button onClick={() => setShowEntities(!showEntities)} className="text-gray-300 hover:text-white">{showEntities ? <ChevronUp className="w-4 h-4" /> : <ChevronDown className="w-4 h-4" />}</button>
            </div>
            {showEntities && (
              <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-2 max-h-64 overflow-y-auto">
                {allEntities.map((entity) => (<div key={entity.id} className="bg-purple-500/20 rounded p-2 border border-purple-400/30"><div className="text-white text-xs font-bold truncate">{entity.name}</div><p className="text-gray-300 text-xs mt-1 truncate">{entity.description}</p><div className="text-purple-300 text-xs mt-1 opacity-80">{entity.category}</div></div>))}
              </div>
            )}
          </div>
        )}

        {layer2IterationHistory.length > 0 && (
          <div className="bg-white/10 backdrop-blur-md rounded-xl p-3 mb-4 border border-white/20">
            <div className="flex items-center justify-between mb-2">
              <h3 className="text-white font-bold text-sm flex items-center gap-2"><Lightbulb className="w-4 h-4" />ç”Ÿæˆã•ã‚ŒãŸã‚¢ã‚¤ãƒ‡ã‚¢ï¼ˆç¬¬2å±¤ï¼‰</h3>
              <button onClick={() => setShowIdeas(!showIdeas)} className="text-gray-300 hover:text-white">{showIdeas ? <ChevronUp className="w-4 h-4" /> : <ChevronDown className="w-4 h-4" />}</button>
            </div>
            {showIdeas && (
              <div className="space-y-3">
                {layer2IterationHistory.map((iter, idx) => (
                  <div key={idx}>
                    <h4 className="text-blue-300 font-bold text-xs mb-1">--- åå¾© {iter.iteration} ---</h4>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                      {iter.results.flatMap(r => (r && r.ideas) ? r.ideas : []).map(idea => (<div key={idea.id} className="bg-blue-500/20 rounded p-2 border border-blue-400/30"><div className="text-white font-medium text-xs">{idea.title}</div><p className="text-gray-300 text-xs mt-1">{idea.description}</p><div className="text-blue-200 text-xs mt-1 opacity-80">åŸºç¤: {idea.asIsBasis}</div></div>))}
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        )}

        {layer3Results.length > 0 && (
          <div className="bg-white/10 backdrop-blur-md rounded-xl p-3 mb-4 border border-white/20">
            <div className="flex items-center justify-between mb-2">
              <h3 className="text-white font-bold text-sm flex items-center gap-2"><GitBranch className="w-4 h-4" />æ§‹é€ åŒ–åˆ†æï¼ˆç¬¬3å±¤ï¼‰</h3>
              <button onClick={() => setShowStructures(!showStructures)} className="text-gray-300 hover:text-white">{showStructures ? <ChevronUp className="w-4 h-4" /> : <ChevronDown className="w-4 h-4" />}</button>
            </div>
            {showStructures && (
               <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                {layer3Results.map(result => (
                  result && <div key={result.agentId} className="bg-cyan-500/20 p-2 rounded border border-cyan-400/30">
                    <h4 className="text-cyan-300 font-bold text-xs mb-2">æ‰‹æ³•: {structuringMethods.find(m => m.id === result.method)?.name}</h4>
                    {result.structuredData && result.structuredData.map(data => (<div key={data.id} className="mb-2"><div className="text-white font-medium text-xs">{data.name}</div><p className="text-gray-300 text-xs mt-1">{data.description}</p><p className="text-cyan-200 text-xs mt-1">æ´å¯Ÿ: {data.insights}</p></div>))}
                  </div>
                ))}
               </div>
            )}
          </div>
        )}
        
        {layer4Results.length > 0 && (
          <div className="bg-white/10 backdrop-blur-md rounded-xl p-3 mb-4 border border-white/20">
            <div className="flex items-center justify-between mb-2">
              <h3 className="text-white font-bold text-sm flex items-center gap-2"><Combine className="w-4 h-4" />çµ±åˆæ¡ˆï¼ˆç¬¬4å±¤ï¼‰</h3>
              <button onClick={() => setShowSolutions(!showSolutions)} className="text-gray-300 hover:text-white">{showSolutions ? <ChevronUp className="w-4 h-4" /> : <ChevronDown className="w-4 h-4" />}</button>
            </div>
            {showSolutions && (
              <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                {layer4Results.flatMap(r => (r && r.solutions) ? r.solutions : []).map(sol => (<div key={sol.id} className="bg-green-500/20 p-3 rounded border border-green-400/30"><h4 className="text-white font-bold text-sm mb-1">{sol.title}</h4><p className="text-gray-300 text-xs mb-2">{sol.description}</p><div className="bg-black/20 p-1.5 rounded"><p className="text-green-300 text-xs"><span className="font-bold">æœ€åˆã®ä¸€æ­©:</span> {sol.quickWin}</p><p className="text-green-300 text-xs mt-1"><span className="font-bold">æœŸå¾…æˆæœ:</span> {sol.expectedOutcome}</p></div></div>))}
              </div>
            )}
          </div>
        )}

        {finalReport && finalReport.ranking && (
          <div className="bg-white/10 backdrop-blur-md rounded-xl p-4 border border-white/20">
            <h2 className="text-xl font-bold text-white mb-3 flex items-center gap-2"><Award className="w-5 h-5 text-yellow-400" />æœ€çµ‚ãƒ©ãƒ³ã‚­ãƒ³ã‚° ({finalReport.totalTargets}å¯¾è±¡ã€{finalReport.totalEvaluators}è©•ä¾¡è€…)</h2>
            <div className="space-y-2">
              {finalReport.ranking.map((item, index) => (
                <div key={index} className={`rounded p-3 border ${
                  index === 0 ? 'bg-yellow-500/20 border-yellow-400' :
                  index === 1 ? 'bg-gray-400/20 border-gray-400' :
                  index === 2 ? 'bg-orange-500/20 border-orange-400' : 'bg-white/5 border-white/20'
                }`}>
                  <div className="flex items-start justify-between">
                    <div className="flex items-start gap-3 flex-1">
                      <span className={`text-2xl font-bold ${
                        index === 0 ? 'text-yellow-400' :
                        index === 1 ? 'text-gray-300' :
                        index === 2 ? 'text-orange-400' : 'text-gray-400'
                      }`}>#{index + 1}</span>
                      <div className="flex-1">
                        <h3 className="text-white font-bold mb-1">{item.target.title}</h3>
                        <p className="text-gray-300 text-sm mb-2">{item.target.description || ''}</p>
                        <div className="flex items-center gap-2">
                          <span className="text-xs bg-blue-500/30 text-blue-300 px-2 py-0.5 rounded">{item.target.type === 'solution' ? 'çµ±åˆæ¡ˆ' : 'ã‚¢ã‚¤ãƒ‡ã‚¢'}</span>
                          <span className="text-xs text-gray-400">ID: {item.target.id}</span>
                        </div>
                        {item.evaluatorDetails && item.evaluatorDetails.length > 0 && (
                          <div className="mt-2 grid grid-cols-2 gap-2">
                            {item.evaluatorDetails.map((detail, di) => (<div key={di} className="bg-black/30 rounded p-1 text-xs"><span className="text-yellow-300">{detail.criteria}:</span><span className="text-white ml-1">{detail.score}ç‚¹</span></div>))}
                          </div>
                        )}
                      </div>
                    </div>
                    <div className="text-right">
                      <span className="text-2xl font-bold text-purple-400">{item.average.toFixed(1)}ç‚¹</span>
                      <div className="text-xs text-gray-400 mt-1">{item.scores.length}è©•ä¾¡</div>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}

      </div>
    </div>
  );
};

export default AIEconomySystemV4;

